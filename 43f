#!/bin/bash

# 
# 43f - A simple date-based storage management utility based on the forty-three 
#        folders concept from David Allen's "Getting Things Done" program. It
#        maintains 43 folders per year (one for every month [12] and one for 
#        every possible date in a month [31], therefore allowing you to store 
#        up to 31 daily file sets, 12 monthly file sets, and as many annual 
#        file sets as you would like. It is ideal for managing backup/snapshot
#        sets, but should be flexible enough for any number of uses.
# 
# CHANGE LOG:
# 
# v0.1   - 2009-03-07 - Morgan Aldridge <morgant@makkintosshu.com>
#                       Initial development.
# 
# LICENSE:
# 
# Copyright (c) 2012, Morgan Aldridge. All rights reserved.
# 
# Redistribution and use in source and binary forms, with or without 
# modification, are permitted provided that the following conditions are met:
# 
# - Redistributions of source code must retain the above copyright notice, this 
#   list of conditions and the following disclaimer.
# - Redistributions in binary form must reproduce the above copyright notice, 
#   this list of conditions and the following disclaimer in the documentation 
#   and/or other materials provided with the distribution.
# 
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" 
# AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE 
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE 
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL 
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR 
# SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER 
# CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, 
# OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE 
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
# 

# info
tool=$(basename "$0")
version='0.1'
copyright='Copyright (c) 2009-2012 Morgan Aldridge'

# global variables
verbose=false
dry_run=false
config_file='/usr/local/etc/43f.conf'
config_repository='/usr/local/var/db/43f'
config_notify_email='root'
config_keep_days=31
config_keep_months=12
config_keep_years=10

y=`date "+%Y"`
m=`date "+%m"`
d=`date "+%d"`

# print usage instructions (help)
function usage() {
	echo "Usage: $tool [-h|-t|-V] [-v] [-c file] COMMAND"
	echo
	echo 'Options:'
	echo '  -v                : verbose output'
	echo '  -V, --version     : print the version number and exit'
	echo '  -h, --help        : print these usage instructions and exit'
	echo '  -c, --config=file : specify an alternate config file'
	echo '             DEFAULT: /usr/local/etc/43f.conf'
	echo '  -t                : check the config file and exit'
	echo "  -n, --dry-run     : don't actually move/delete any files"
	echo
	echo 'Commands:'
	echo '  init <path>       : initialize specified repository'
	echo '  run               : perform storage management'
	echo
	echo 'Config File Options:'
	echo '  repository        : absolute path to archive repository'
	echo '             DEFAULT: /usr/local/var/db/43f'
	echo '  notify            : email address(es) to send notifications to'
	echo '             DEFAULT: root'
	echo '  days              : number of daily file sets to preserve (1-31)'
	echo '             DEFAULT: 31'
	echo '  months            : number of monthly file sets to preserve (1-12)'
	echo '             DEFAULT: 12'
	echo '  years             : number of annual file sets to preserve (1+)'
	echo '             DEFAULT: 10'
}

# print version info
function version() {
	echo "$tool v$version $copyright"
}

# load the config file
function load_config() {
	local success
	local var
	local val
	local config_file
	success=true
	config_file="$1"
	# does the config file exist?
	if [ -n "$config_file" -a -e "$config_file" ]; then
		if $verbose; then echo "Loading config file '${config_file}'."; fi
		IFS==
		while read var val; do
			case "$var" in
				\#*)
					# do nothing - this would be a comment
					;;
				repository)
					if [ -n "$val" -a -d "$val" ]; then
						config_repository="$val"
						if $verbose ; then
							printf "'%s' set to '%s'.\n" "$var" "$config_repository"
						fi
					else
						printf "ERROR! '%s' value in config file is either invalid or not a directory! You may need to run '43f init' to initialize the repository.\n" "$var"
						success=false
					fi
					;;
				notify)
					if echo "$val" | grep -q -i -E '^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,4}$' ; then
						config_notify_email="$val"
						if $verbose ; then
							printf "'%s' set to '%s'.\n" "$var" "$config_notify_email"
						fi
					else
						printf "ERROR! '%s' value in config file is not a valid email address!\n" "$var"
						success=false
					fi
					;;
				days)
					if (( ( "$val" >= 1 ) && ( "$val" <= 31 ) )); then
						config_keep_days="$val"
						if $verbose; then echo "'$var' set to '$config_keep_days'."; fi
					else
						echo "ERROR! '$var' value in config file is out of range (1-31)!"
						success=false
					fi
					;;
				months)
					if (( ( "$val" >= 1 ) && ( "$val" <= 12 ) )); then
						config_keep_months="$val"
						if $verbose; then echo "'$var' set to '$config_keep_months'."; fi
					else
						echo "ERROR! '$var' value in config file is out of range (1-12)!"
						success=false
					fi
					;;
				years)
					if (( "$val" >= 1 )); then
						config_keep_years="$val"
						if $verbose; then echo "'$var' set to '$config_keep_years'."; fi
					else
						echo "ERROR! '$var' value in config file is out of range (1+)!"
						success=false
					fi
					;;
				*)
					printf "Warning: Ignored unknown configuration variable '%s'.\n" "$var"
					;;
			esac
		done < "$config_file"
	else
		if $verbose; then echo "ERROR! Config file '${config_file}' does not exist!"; fi
		success=false
	fi
		
	$success
}

# determine whether repository exists
function does_repository_exist() {
	local success
	local repo
	success=true
	repo="$1"
	
	if [ -z "$repo" -o ! -d "$repo" ]; then
		success=false
	fi
	
	$success
}

# initialize the repository
function init_repository() {
	local success
	local repo
	success=true
	repo="$1"
	
	# does the repository exist?
	if [ -z "$repo" ]; then
		echo 'ERROR! Cannot initialize repository with empty path!'
		success=false
	else
		if $verbose; then echo -n "Repository directory '$repo' "; fi
		if does_repository_exist "$repo"; then
			if $verbose; then echo 'exists.'; fi
		else
			if $verbose ; then echo -n 'does not exist. Creating... '; fi
			if mkdir -p $repo; then
				if $verbose; then echo 'Done.'; fi
			else
				if $verbose; then echo 'Error!'; fi
				success=false
			fi
		fi
	fi
		
	# check for year subdirectory & create if necessary
	if $success; then
		year_dir="$repo/$y"
		if $verbose ; then
			printf "Year Directory '%s' " "$year_dir"
		fi
		if [ -d "$year_dir" ] ; then
			if $verbose ; then
				printf "exists.\n"
			fi
		else
			if $verbose; then
				printf "does not exist. Creating... "
			fi
			if mkdir $year_dir ; then
				if $verbose ; then
					printf "Done.\n"
				fi
			else
				if $verbose ; then
					printf "ERROR!\n"
				fi
				success=false
			fi
		fi
	fi
	
	# step through the month directories, checking for them & creating as necessary
	if $success; then
		local month
		for (( month=1; month<=12; month++ )); do
			local month_dir
			# check for month directory
			printf -v month_dir "%s/%s/m%02d" "$repo" "$y" "$month"
			if $verbose; then echo -n "Month Directory ${month_dir} "; fi
			if [ -d "$month_dir" ]; then
				if $verbose; then echo "exists."; fi
			else
				# create the month directory
				if $verbose; then echo -n "does not exist. Creating... "; fi
				if mkdir $month_dir; then
					if $verbose; then echo "Done."; fi
				else
					if $verbose; then echo "ERROR!"; fi
					success=false
				fi
			fi
		done
	fi
	
	# step through the day directories, checking for them & creating as necessary
	if $success; then
		local day
		for (( day=1; day<=31; day++ )); do
		      local day_dir
		      # check for the day directory
		      printf -v day_dir "%s/%s/d%02d" "$repo" "$y" "$day"
		      if $verbose; then echo -n "Day Directory ${day_dir} "; fi
		      if [ -d "$day_dir" ]; then
		      	if $verbose; then echo "exists."; fi
		      else
		      	# create the day directory
		      	if $verbose; then echo -n "does not exist. Creating... "; fi
		      	if mkdir $day_dir; then
		      		if $verbose; then echo "Done."; fi	
		      	else
		      		if $verbose; then echo "ERROR!"; fi
		      		success=false
		      	fi
		      fi
		done
	fi
	
	$success
}

function init_repository_symlinks() {
	local success
	local repo
	success=true
	repo="$1"
	
	if does_repository_exist "$repo"; then
		# create symlink for 'today'
		local today_dir
		local today
		today="$d"
		today_dir="$repo/$y/d${today}"
		if $verbose; then echo -n "Creating symlink for 'today' pointing to '$today_dir'... "; fi
		if ln -f -h -s "$today_dir" "$repo/today"; then
			if $verbose; then echo 'Done.'; fi
		else
			if $verbose; then echo 'ERROR!'; fi
			success=false
		fi
		
		# create symlink for 'yesterday'
		local yesterday_dir
		local yesterday
		yesterday=$(date -v-1d +%d)
		yesterday_dir="$repo/$y/d${yesterday}"
		if $verbose; then echo -n "Creating symlink for 'yesterday' pointing to '$yesterday_dir'... "; fi
		if ln -f -h -s "$yesterday_dir" "$repo/yesterday"; then
			if $verbose; then echo 'Done.'; fi
		else
			if $verbose; then echo 'ERROR!'; fi
			success=false
		fi
		
		# create symlink for 'sunday' through 'saturday' for the past week (not including today)
		local weekday_dir
		local weekday_name
		local weekday
		for (( i=1; i<=7; i++ )); do
			weekday=$(date -v-${i}d +%d)
			weekday_dir="$repo/$y/d${weekday}"
			weekday_name=$(date -v-${i}d +%A | tr '[:upper:]' '[:lower:]')
			if $verbose; then echo -n "Creating symlink for '$weekday_name' pointing to '$weekday_dir'... "; fi
			if ln -f -h -s "$weekday_dir" "$repo/$weekday_name"; then
				if $verbose; then echo 'Done.'; fi
			else
				if $verbose; then echo 'ERROR!'; fi
				success=false
			fi
		done
	else
		if $verbose; then echo "ERROR! Repository '${repo}' doesn't exist!"; fi
		success=false
	fi
	
	$success
}

function roll_repository_daily_to_monthly() {
	local success=true
	local repo="$1"
	local day="$2"
	local month="$3"
	local mtime_today="$4"	# also include files modified today? "true"/"false"
	local year="$y"
	
	if does_repository_exist "$repo"; then
		local src
		local dst
		printf -v src "%s/%s/d%02d" "$repo" "$year" "$day"
		printf -v dst "%s/%d/m%02d" "$repo" "$year" "$month"
		if $verbose; then echo -n "Moving files & directories from '$src' to '$dst' ("; fi
		if $mtime_today; then
			if $verbose; then echo -n "including"; fi
		else
			if $verbose; then echo -n "excluding"; fi
		fi
		if $verbose; then echo -n " those modified today)... "; fi
		
		# step through all the matching (i.e. with or without a modification date of today) in the src dir and move them to dst
		while IFS= read -r line; do
			# don't bother processing an empty line or is the src directory itself
			if [ -n "$line" ]; then
				if $verbose; then echo -n "'$line'... "; fi
				if ! $dry_run; then
					if mv "$line" "$dst/"; then
						echo "Done."
					else
						echo "ERROR!"
						success=false
					fi
				elif $verbose; then
					echo "Done."
				fi
			fi
		done <<< "$(find "$src" -depth 1)"
		
		
		if $verbose; then echo "Done."; fi
	else
		if $verbose; then echo "ERROR! Repository '${repo}' doesn't exist!"; fi
		success=false
	fi
	
	$success
}

function roll_repository_directories() {
	local success=true
	local repo="$1"
	
	if does_repository_exist "$repo"; then
		# calculate today & keep-through dates
		local today="$d"
		local keep_through=$(date -v-${config_keep_days}d +%d)
		if $verbose; then echo "Keeping files through 'd${keep_through}'."; fi
		
		# step through the subdirectories and "process" those that are outside the range to preserve (starting with yesterday)
		local year="$y"
		local month="$m"
		local day=$(date -v-1d +%d)
		local day_dir=''
		local month_dir=''
		while (( "$day" != "$today" )); do
			# build the directory paths
			printf -v day_dir "%s/%d/d%02d" "$repo" "$year" "$day"
			printf -v month_dir "%s/%d/m%02d" "$repo" "$year" "$month"
			
			if $verbose; then echo -n "Processing directory '$day_dir'... "; fi
			# are we keeping a range that doesn't wrap (i.e. today is greater than the day through which we're keeping)?
			if (( ( $today >= $keep_through ) && ( $day >= $keep_through ) && ( $day <= $today ) )); then
				if $verbose; then echo 'Keeping.'; fi
			# or, are we keeping a range that wraps (i.e. the day through which we're keeping is greater than today)?
			elif (( ( $today <= $keep_through ) && ( ( $day <= $today ) || ( $day >= $keep_through ) ) )); then
				if $verbose; then echo 'Keeping.'; fi
			# only process if this is outside the range to keep
			else
				if $verbose; then echo -n 'Processing...'; fi
				
				# move the contents of the day's directory to the appropriate month's directory
				if roll_repository_daily_to_monthly "$repo" "$day" "$month" true; then
					if $verbose; then echo "Done."; fi
				else
					echo 'ERROR!'
					echo "A fatal error occurred while processing attempting to move the contents of '$day_dir' to '$month_dir'!"
					echo 'Exiting.'
					exit 1
				fi
			fi
			
			# decrement the day & wrap around day, month, and year if we've gone under
			(( day-- ))
			if (( "$day" < 1 )); then
				day=31
				(( month-- ))
				if (( "$month" < 1 )); then
					month=12
					(( year-- ))
				fi
			fi
		done
		
		# we always process today (but we have to be extra careful since there's the possibility new files have already been stashed in it)
		printf -v day_dir "%s/%d/d%02d" "$repo" "$year" "$day"
		printf -v month_dir "%s/%d/m%02d" "$repo" "$year" "$month"
		if $verbose; then echo -n "Processing directory '$day_dir'... Processing (special)... "; fi
		# move the contents of the day's directory to the appropriate month's directory
		if roll_repository_daily_to_monthly "$repo" "$day" "$month" false; then
			if $verbose; then echo "Done."; fi
		else
			echo 'ERROR!'
			echo "A fatal error occurred while processing attempting to move the contents of '$day_dir' to '$month_dir'!"
			echo 'Exiting.'
			exit 1
		fi
	else
		if $verbose; then echo "ERROR! Repository '${repo}' doesn't exist!"; fi
		success=false
	fi
	
	$success
}

# see if any arguments were passed in
if [ $# -gt 0 ]; then
	# if so, step through them all and pre-process them (we do this so we can 
	# support multiple options specified together, e.g.: -abc vs. -a -b -c),
	# GNU-style long options with alternate style values, and for easier
	# actual handling
	argv=()
	while [ $# -gt 0 ]; do
		# is this an option (e.g. starts with a dash) or an argument?
		if [ "${1:0:1}" = "-" ]; then
			# is it a GNU-style long option (e.g. starts with a double-dash)?
			if [ "${1:0:2}" = "--" ]; then
				# push the option (everything before an equals) onto argv
				argv=("${argv[@]}" "${1%%=*}")
				
				# is it the alternate "--long-opt=value" format? if so, make it
				# "--long-opt value" format buy pushing the value (everything after the
				# equals) on as a separate argument
				case "$1" in *=*)
					argv=("${argv[@]}" "${1##*=}") ;;
				esac
			# otherwise, is it multiple single options specified together?
			elif [ ${#1} -gt 2 ]; then
				tmp="$1"
				# push each onto argv as single options
				for (( i=1; i < ${#tmp}; i++ )); do
					argv=("${argv[@]}" "-${tmp:$i:1}")
				done
			# otherwise, it must be a single option so just push it onto argv
			else
				argv=("${argv[@]}" "$1")
			fi
			shift
		# arguments just get pushed onto argv in order too
		else
			argv=("${argv[@]}" "$1")
			shift
		fi
	done
	argc=${#argv[@]}
		
	# now that we've pre-processed the options, go through them all for real
	for (( i=0; i<$argc; i++ )); do
		# is this an option (e.g. starts with a dash) or an argument?
		if [ "${argv[$i]:0:1}" = "-" ]; then
			case "${argv[$i]}" in
				# see if the user intended us to run in verbose mode
				"-v" | "--verbose")
					verbose=true
					;;
				# see if the user requested help
				"-h" | "--help")
					usage
					exit
					;;
				# see if the user requested the version
				"-V" | "--version")
					version
					exit
					;;
				# see if the user is specifying a config file
				"-c" | "--config")
					# the next argument should be the config file
					((i++))
					config_file="${argv[$i]}"
					
					# does the config file exist?
					if [ -n "$config_file" -a -e "$config_file" ]; then
						if $verbose; then echo "Using config file '${config_file}'."; fi
					else
						echo "ERROR! Config file '${config_file}' does not exist!"
						echo 'Exiting.'
						exit 1
					fi
					;;
				# see if the user is requesting we test the config file
				"-t")
					# load the config file
					if load_config "$config_file"; then
						echo "Config file '${config_file}' loaded & tested successfully."
						echo 'Exiting.'
						exit
					else
						echo "ERROR! An error occurred while loading the config file '${config_file}'!"
						echo 'Exiting.'
						exit 1
					fi
					;;
				# see if the user is requesting a dry run
				"-n" | "--dry-run")
					dry_run=true
					;;
				# handle other options
					
				# unknown option
				*)
					echo "$tool: Unknown option '$1'!"
					exit 1
					;;
			esac
		# handle arguments
		else
			# one would normally handle arguments here
			case "${argv[$i]}" in
				# see if the user specified we initialize a repository
				init)
					((i++))
					repository_dir="${argv[$i]}"
					# check/create repository directories
					if init_repository "$repository_dir"; then
					      if $verbose; then echo 'Repository directories found/created successfully.'; fi
					else
					      echo "ERROR! An error occurred while checking or creating the repository directories in '${config_repository}'!"
					      echo 'Exiting.'
					      exit 1
					fi
					;;
				# see if the user specified we run storage management process
				run)
					# load the config file
					if load_config "$config_file"; then
						# update convenience symlinks
						if $verbose; then echo -n "Updating convenience symlinks in repository '${config_repository}'... "; fi
						if init_repository_symlinks "$config_repository"; then
							if $verbose; then echo 'Done.'; fi
						else
							if $verbose; then echo 'ERROR!'; fi
							echo 'WARNING: An error occurred while creating/updating convenience symlinks. Proceeding, but something may be wrong!'
						fi
						
						# roll the file sets in the directories
						if $verbose; then echo -n "Processing directories in repository '${config_repository}'... "; fi
						if roll_repository_directories "$config_repository"; then
							if $verbose; then echo 'Done.'; fi
						else
							if $verbose; then echo 'ERROR!'; fi
							exit 1
						fi
					else
						echo "ERROR! An error occurred while loading the config file '${config_file}'!"
						echo 'Exiting.'
						exit 1
					fi
					;;
				*)
					echo "$tool: Unknown command '${argv[$i]}'!"
					exit 1
					;;
			esac
		fi
	done
else
	echo "No options or arguments were specified!"$'\n'
	usage
	exit 1
fi